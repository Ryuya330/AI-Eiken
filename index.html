<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI英検パートナー：ソフィア</title>

    <!-- OGP Tags for Social Sharing -->
    <meta property="og:title" content="AI英検パートナー：ソフィア" />
    <meta property="og:description" content="AIが英検の全級・全形式に対応した問題を自動生成。あなたの実力に合わせた最適な学習パートナーです。" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="YOUR_WEBSITE_URL_HERE" />
    <meta property="og:image" content="https://placehold.co/1200x630/0ea5e9/ffffff?text=AI%E8%8B%B1%E6%A4%9C%E3%83%91%E3%83%BC%E3%83%88%E3%83%8A%E3%83%BC%EF%BC%9A%E3%82%BD%E3%83%95%E3%82%A3%E3%82%A2" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />

    <!-- Scripts -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @media print {
          body { background-color: #fff; }
          .no-print { display: none !important; }
          .printable-area { box-shadow: none !important; border: 1px solid #ccc; padding: 1rem; }
          .printable-area audio { display: none; }
        }
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.5s ease-out forwards; }
        @keyframes pulse { 50% { opacity: .5; } }
        .animate-pulse { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Helper Functions for Audio/Image Processing ---
        function base64ToArrayBuffer(base64) {
          const binaryString = window.atob(base64);
          const len = binaryString.length;
          const bytes = new Uint8Array(len);
          for (let i = 0; i < len; i++) {
            bytes[i] = binaryString.charCodeAt(i);
          }
          return bytes.buffer;
        }
        function pcmToWav(pcmData, sampleRate) {
          const numChannels = 1;
          const bitsPerSample = 16;
          const byteRate = sampleRate * numChannels * (bitsPerSample / 8);
          const blockAlign = numChannels * (bitsPerSample / 8);
          const dataSize = pcmData.length * (bitsPerSample / 8);
          const chunkSize = 36 + dataSize;
          const buffer = new ArrayBuffer(44 + dataSize);
          const view = new DataView(buffer);
          view.setUint32(0, 0x52494646, false); view.setUint32(4, chunkSize, true); view.setUint32(8, 0x57415645, false);
          view.setUint32(12, 0x666d7420, false); view.setUint32(16, 16, true); view.setUint16(20, 1, true);
          view.setUint16(22, numChannels, true); view.setUint32(24, sampleRate, true); view.setUint32(28, byteRate, true);
          view.setUint16(32, blockAlign, true); view.setUint16(34, bitsPerSample, true);
          view.setUint32(36, 0x64617461, false); view.setUint32(40, dataSize, true);
          const pcm16 = new Int16Array(buffer, 44); pcm16.set(pcmData);
          return new Blob([view], { type: 'audio/wav' });
        }

        // --- Main App Component ---
        function App() {
          const [user, setUser] = React.useState(null);
          const [view, setView] = React.useState('app');
          const [loadingAuth, setLoadingAuth] = React.useState(true);

          React.useEffect(() => {
            const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
              if (currentUser) {
                setUser(currentUser);
                setLoadingAuth(false);
              } else {
                signInAnonymously(auth).catch((error) => {
                  console.error("Anonymous sign-in failed:", error);
                  setLoadingAuth(false);
                });
              }
            });
            return () => unsubscribe();
          }, []);
          
          const renderCurrentView = () => {
            if (loadingAuth) {
                return <div className="text-center p-10">ユーザー情報を読み込んでいます...</div>;
            }
            if (!user) {
                return <div className="text-center p-10 text-red-500">ユーザー認証に失敗しました。ページをリロードしてください。</div>;
            }

            switch(view) {
              case 'history':
                return <HistoryView user={user} />;
              case 'app':
              default:
                return <EikenApp user={user} />;
            }
          };

          return (
            <div className="bg-slate-50 min-h-screen font-sans text-slate-800 flex flex-col items-center p-4 sm:p-6 md:p-8">
                <header className="w-full max-w-2xl mx-auto mb-8 no-print">
                  {user && (
                    <div className="flex justify-end mb-2">
                        <button onClick={() => setView(view === 'app' ? 'history' : 'app')} className="bg-sky-100 hover:bg-sky-200 text-sky-700 font-bold py-2 px-4 rounded-lg text-sm transition-colors">
                            {view === 'app' ? 'マイページ' : '問題に戻る'}
                        </button>
                    </div>
                  )}
                  <h1 className="text-2xl sm:text-4xl font-bold text-sky-600 text-center">AI英検パートナー：ソフィア</h1>
                </header>
                <div className="w-full max-w-2xl mx-auto">
                    {renderCurrentView()}
                </div>
                <footer className="text-center mt-12 text-slate-400 text-xs sm:text-sm no-print">
                    <p>英検®は、公益財団法人 日本英語検定協会の登録商標です。</p>
                    <p>このコンテンツは、公益財団法人 日本英語検定協会の承認や推奨、その他の検討を受けたものではありません。</p>
                </footer>
            </div>
          );
        }

        // --- Eiken App Component ---
        function EikenApp({ user }) {
          const [level, setLevel] = React.useState('3kyu');
          const [questionType, setQuestionType] = React.useState('grammar');
          const [questionSource, setQuestionSource] = React.useState('ai');
          const [problem, setProblem] = React.useState(null);
          const [isLoading, setIsLoading] = React.useState(false);
          const [isAudioLoading, setIsAudioLoading] = React.useState(false);
          const [isImageLoading, setIsImageLoading] = React.useState(false);
          const [showAnswer, setShowAnswer] = React.useState(false);
          const [error, setError] = React.useState(null);
          const [userWriting, setUserWriting] = React.useState('');
          const [audioUrl, setAudioUrl] = React.useState(null);
          const [imageUrl, setImageUrl] = React.useState(null);
          const [interviewStage, setInterviewStage] = React.useState('not_started');
          const [currentQuestionIndex, setCurrentQuestionIndex] = React.useState(0);
          const [selectedAnswer, setSelectedAnswer] = React.useState(null);
          const [timeLeft, setTimeLeft] = React.useState(60);
          const [isTimerActive, setIsTimerActive] = React.useState(false);

          const levels = [
            { id: '1kyu', name: '1級' }, { id: 'jun1kyu', name: '準1級' }, { id: '2kyu', name: '2級' },
            { id: 'jun2kyu-plus', name: '準2級プラス' }, { id: 'jun2kyu', name: '準2級' }, { id: '3kyu', name: '3級' },
            { id: '4kyu', name: '4級' }, { id: '5kyu', name: '5級' },
          ];

          const questionTypes = {
            '1kyu': [ { id: 'grammar', name: '短文の語句空所補充', time: 90 }, { id: 'reading', name: '長文の内容一致選択', time: 180 }, { id: 'writing', name: 'ライティング (意見論述)', time: 1500 }, { id: 'listening', name: 'リスニング (会話)', time: 90 }, { id: 'speaking', name: 'スピーキング面接', time: 600 } ],
            'jun1kyu': [ { id: 'grammar', name: '短文の語句空所補充', time: 75 }, { id: 'reading', name: '長文の内容一致選択', time: 150 }, { id: 'writing', name: 'ライティング (意見論述)', time: 1500 }, { id: 'listening', name: 'リスニング (会話)', time: 90 }, { id: 'speaking', name: 'スピーキング面接', time: 600 } ],
            '2kyu': [ { id: 'grammar', name: '短文の語句空所補充', time: 60 }, { id: 'reading', name: '長文の内容一致選択', time: 120 }, { id: 'writing', name: 'ライティング (Eメール)', time: 900 }, { id: 'listening', name: 'リスニング (会話)', time: 75 }, { id: 'speaking', name: 'スピーキング面接', time: 540 } ],
            'jun2kyu-plus': [ { id: 'grammar', name: '短文の語句空所補充', time: 60 }, { id: 'reading', name: '長文の内容一致選択', time: 120 }, { id: 'writing', name: 'ライティング (Eメール)', time: 900 }, { id: 'listening', name: 'リスニング (会話)', time: 75 }, { id: 'speaking', name: 'スピーキング面接', time: 540 } ],
            'jun2kyu': [ { id: 'grammar', name: '短文の語句空所補充', time: 60 }, { id: 'reading', name: '長文の内容一致選択', time: 120 }, { id: 'writing', name: 'ライティング (Eメール)', time: 900 }, { id: 'listening', name: 'リスニング (会話)', time: 75 }, { id: 'speaking', name: 'スピーキング面接', time: 540 } ],
            '3kyu': [ { id: 'grammar', name: '短文の語句空所補充', time: 60 }, { id: 'reading', name: '長文の内容一致選択', time: 120 }, { id: 'writing', name: 'ライティング (Eメール)', time: 900 }, { id: 'listening', name: 'リスニング (会話)', time: 60 }, { id: 'speaking', name: 'スピーキング面接', time: 420 } ],
            '4kyu': [ { id: 'grammar', name: '短文の語句空所補充', time: 60 }, { id: 'listening', name: 'リスニング (イラスト)', time: 60 } ],
            '5kyu': [ { id: 'grammar', name: '短文の語句空所補充', time: 60 }, { id: 'listening', name: 'リスニング (イラスト)', time: 60 } ],
          };
          
          React.useEffect(() => {
            if (!isTimerActive || !problem) return;
            if (timeLeft <= 0) {
              if (questionType === 'speaking' && interviewStage !== 'finished') {
                handleNextStage();
              } else {
                setIsTimerActive(false);
                setShowAnswer(true);
              }
              return;
            }
            const intervalId = setInterval(() => setTimeLeft(prevTime => prevTime - 1), 1000);
            return () => clearInterval(intervalId);
          }, [timeLeft, isTimerActive, problem]);

          const generateProblem = async () => {
            setIsLoading(true); setError(null); setShowAnswer(false); setProblem(null);
            setUserWriting(''); setAudioUrl(null); setImageUrl(null); setIsTimerActive(false);
            setInterviewStage('not_started'); setCurrentQuestionIndex(0); setSelectedAnswer(null);

            const levelName = levels.find(l => l.id === level)?.name || '';
            const currentQuestionType = questionTypes[level]?.find(t => t.id === questionType);
            const typeName = currentQuestionType?.name || '';
            
            const sourceInstruction = questionSource === 'past_exam' 
              ? "英検公式サイトで公開されている過去3回分の過去問の出題傾向を強く反映させてください。"
              : "あなた独自の完全オリジナル問題を作成してください。";

            let prompt;
            let responseSchema;

            const basePrompt = `あなたは日本の英語教育のエキスパートです。以下の条件で、英検の問題を1つ作成してください。\n# 指示\n${sourceInstruction}`;

            if (questionType === 'speaking') {
                prompt = `${basePrompt}\n# 条件\n- 級: ${levelName}\n- 形式: JSON\n- JSONのキー: "passage", "image_prompt", "questions" (配列)\n# 注意点\n- ... (same as before)`;
                responseSchema = { type: "OBJECT", properties: { "passage": { "type": "STRING" }, "image_prompt": { "type": "STRING" }, "questions": { "type": "ARRAY", "items": { "type": "STRING" } } }, required: ["passage", "image_prompt", "questions"] };
            } else if (questionType === 'listening') {
                prompt = `${basePrompt}\n# 条件\n- 級: ${levelName}\n- 問題形式: ${typeName}\n- 形式: JSON\n- JSONのキー: "script", "question", "choices" (3つ), "answer", "explanation"\n# 注意点\n- ... (same as before)`;
                responseSchema = { type: "OBJECT", properties: { "script": { "type": "STRING" }, "question": { "type": "STRING" }, "choices": { "type": "ARRAY", "items": { "type": "STRING" } }, "answer": { "type": "NUMBER" }, "explanation": { "type": "STRING" } }, required: ["script", "question", "choices", "answer", "explanation"] };
            } else if (questionType === 'writing') {
                prompt = `${basePrompt}\n# 条件\n- 級: ${levelName}\n- 問題形式: ${typeName}\n- 形式: JSON\n- JSONのキー: "question", "sampleAnswer"\n# 注意点\n- ... (same as before)`;
                responseSchema = { type: "OBJECT", properties: { "question": { "type": "STRING" }, "sampleAnswer": { "type": "STRING" }, }, required: ["question", "sampleAnswer"] };
            } else {
                prompt = `${basePrompt}\n# 条件\n- 級: ${levelName}\n- 問題形式: ${typeName}\n- 形式: JSON\n- JSONのキー: "question", "choices" (4つ), "answer", "explanation"\n# 注意点\n- ... (same as before)`;
                responseSchema = { type: "OBJECT", properties: { "question": { "type": "STRING" }, "choices": { "type": "ARRAY", "items": { "type": "STRING" } }, "answer": { "type": "NUMBER" }, "explanation": { "type": "STRING" } }, required: ["question", "choices", "answer", "explanation"] };
            }

            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema } };
            const apiKey = "";
            const textApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(textApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]) {
                    const jsonText = result.candidates[0].content.parts[0].text;
                    const parsedJson = JSON.parse(jsonText);
                    setProblem(parsedJson);

                    if (questionType === 'listening') { setIsAudioLoading(true); await generateAudio(parsedJson.script); }
                    if (questionType === 'speaking') { setIsImageLoading(true); await generateImage(parsedJson.image_prompt); }
                    
                } else { throw new Error("AIから有効な回答が得られませんでした。"); }
            } catch (e) {
                console.error(e); setError("問題の生成に失敗しました。");
            } finally {
                setIsLoading(false); 
            }
          };
          
          const generateImage = async (prompt) => {
            const payload = { instances: [{ prompt }], parameters: { "sampleCount": 1 } };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`Image API Error: ${response.status}`);
                const result = await response.json();
                if (result.predictions?.[0]?.bytesBase64Encoded) {
                    setImageUrl(`data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`);
                } else { throw new Error("画像生成に失敗しました。"); }
            } catch (e) {
                console.error(e); setError("画像生成に失敗しました。");
            } finally {
                setIsImageLoading(false);
            }
          };

          const generateAudio = async (text) => {
            const payload = { contents: [{ parts: [{ text: `TTS the following text with a clear, standard American English accent suitable for an English exam: ${text}` }] }], generationConfig: { responseModalities: ["AUDIO"] }, model: "gemini-2.5-flash-preview-tts" };
            const apiKey = ""; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`TTS API Error: ${response.status}`);
                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                if (part?.inlineData?.data) {
                    const sampleRate = parseInt(part.inlineData.mimeType.match(/rate=(\d+)/)[1], 10);
                    const pcm16 = new Int16Array(base64ToArrayBuffer(part.inlineData.data));
                    setAudioUrl(URL.createObjectURL(pcmToWav(pcm16, sampleRate)));
                } else { throw new Error("TTSから有効な音声データが得られませんでした。"); }
            } catch (e) { console.error(e); setError("音声の生成に失敗しました。"); } finally { setIsAudioLoading(false); }
          };

          const handleShowAnswer = async () => {
            if (selectedAnswer === null && (questionType === 'grammar' || questionType === 'reading' || questionType === 'listening')) return;
            
            setShowAnswer(true);
            setIsTimerActive(false);

            if (user && problem && (questionType === 'grammar' || questionType === 'reading' || questionType === 'listening')) {
                const isCorrect = selectedAnswer === problem.answer;
                const historyData = {
                    userId: user.uid,
                    level: level,
                    questionType: questionType,
                    question: problem.question,
                    userAnswerIndex: selectedAnswer,
                    correctAnswerIndex: problem.answer,
                    isCorrect: isCorrect,
                    timestamp: serverTimestamp()
                };
                try {
                    await addDoc(collection(db, `artifacts/${appId}/users/${user.uid}/history`), historyData);
                } catch (error) {
                    console.error("Error writing document: ", error);
                }
            }
          };

          const handleSelectChoice = (index) => {
            if (showAnswer) return;
            setSelectedAnswer(index);
          };

          const handleNextStage = async () => {
            setIsTimerActive(false);
            setAudioUrl(null);

            if (interviewStage === 'not_started') {
                setInterviewStage('reading');
                setTimeLeft(20);
                setIsTimerActive(true);
            } else if (interviewStage === 'reading') {
                setInterviewStage('answering');
                setCurrentQuestionIndex(0);
                setTimeLeft(40);
                setIsTimerActive(true);
                setIsAudioLoading(true);
                await generateAudio(problem.questions[0]);
            } else if (interviewStage === 'answering') {
                const nextIndex = currentQuestionIndex + 1;
                if (nextIndex < problem.questions.length) {
                    setCurrentQuestionIndex(nextIndex);
                    setTimeLeft(40);
                    setIsTimerActive(true);
                    setIsAudioLoading(true);
                    await generateAudio(problem.questions[nextIndex]);
                } else {
                    setInterviewStage('finished');
                }
            }
          };

          const renderProblem = () => {
            if (!problem || isLoading) return null;
            
            const getChoiceClassName = (index) => {
                if (showAnswer) {
                    if (index === problem.answer) return 'bg-green-100 border-green-500 ring-2 ring-green-500';
                    if (index === selectedAnswer) return 'bg-red-100 border-red-500';
                    return 'bg-slate-50 border-slate-200 opacity-60';
                }
                if (index === selectedAnswer) return 'bg-sky-100 border-sky-500 ring-2 ring-sky-500';
                return 'bg-slate-50 hover:bg-sky-100 border-slate-200 cursor-pointer';
            };

            if (questionType === 'speaking') {
                return (
                    <div className="bg-white p-4 sm:p-6 rounded-xl shadow-md animate-fade-in">
                        <h2 className="text-lg sm:text-2xl font-bold text-slate-800 mb-4 text-center border-b pb-3">スピーキングテスト</h2>
                        {/* ... Speaking UI ... */}
                    </div>
                );
            }
            if (questionType === 'listening' || questionType === 'grammar' || questionType === 'reading') {
                return (
                    <div className="bg-white p-4 sm:p-6 rounded-xl shadow-md animate-fade-in">
                        <div className="mb-6"><h2 className="text-lg sm:text-xl font-semibold text-slate-800 mb-4">問題</h2>
                            <p className="text-sm sm:text-lg text-slate-700 leading-relaxed bg-slate-50 p-4 rounded-lg">{problem.question}</p>
                        </div>
                        {questionType === 'listening' && (
                            <div className="mb-6 text-center">{isAudioLoading ? <div>Loading...</div> : audioUrl && <audio controls src={audioUrl} className="w-full" />}</div>
                        )}
                        <div className="mb-6"><h3 className="text-base sm:text-lg font-semibold text-slate-800 mb-3">選択肢</h3>
                            <div className="space-y-3">
                                {problem.choices.map((choice, index) => (
                                    <div key={index} onClick={() => handleSelectChoice(index)} className={`p-3 sm:p-4 rounded-lg border-2 transition-all duration-200 ${getChoiceClassName(index)}`}>
                                        <p className="text-sm sm:text-base font-medium">{index + 1}. {choice}</p>
                                    </div>
                                ))}
                            </div>
                        </div>
                        {!showAnswer ? <button onClick={handleShowAnswer} className="w-full bg-amber-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-amber-600 transition disabled:bg-amber-300" disabled={selectedAnswer === null}>答えを見る</button> : <div className="p-4 bg-slate-100 rounded-lg animate-fade-in"><h3 className="text-base sm:text-xl font-semibold text-green-700 mb-2">正解と解説</h3><p className="font-bold text-lg sm:text-2xl mb-3 text-slate-800">答え: {problem.answer + 1}. {problem.choices[problem.answer]}</p>{questionType === 'listening' && <p className="text-sm sm:text-base text-slate-600 leading-relaxed mb-2"><b>スクリプト:</b> {problem.script}</p>}<p className="text-sm sm:text-base text-slate-600 leading-relaxed"><b>解説:</b> {problem.explanation}</p></div>}
                    </div>
                );
            } else if (questionType === 'writing') {
                return (
                    <div className="bg-white p-4 sm:p-6 rounded-xl shadow-md animate-fade-in">
                      <div className="mb-6"><h2 className="text-lg sm:text-xl font-semibold text-slate-800 mb-4">問題</h2><p className="text-sm sm:text-lg text-slate-700 leading-relaxed whitespace-pre-wrap bg-slate-50 p-4 rounded-lg">{problem.question}</p></div>
                      <div className="mb-6"><h3 className="text-base sm:text-lg font-semibold text-slate-800 mb-3">あなたの解答</h3><textarea value={userWriting} onChange={(e) => setUserWriting(e.target.value)} className="w-full h-48 p-3 bg-slate-100 border-2 border-slate-200 focus:border-sky-500 focus:ring-sky-500 rounded-lg transition text-sm sm:text-base" placeholder="ここに解答を入力してください..." disabled={showAnswer} /><p className="text-right text-xs sm:text-sm text-slate-500 mt-1">{userWriting.split(/\s+/).filter(Boolean).length} words</p></div>
                      {!showAnswer ? <button onClick={handleShowAnswer} className="w-full bg-amber-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-amber-600 transition">模範解答を見る</button> : <div className="p-4 bg-green-50 rounded-lg animate-fade-in border border-green-200"><h3 className="text-base sm:text-xl font-semibold text-green-800 mb-2">模範解答</h3><p className="text-sm sm:text-base text-slate-700 leading-relaxed whitespace-pre-wrap">{problem.sampleAnswer}</p></div>}
                    </div>
                );
            }
          };

          return (
            <div>
                <p className="text-center text-sm sm:text-base text-slate-500 mt-2 mb-6 no-print">AIがあなたに合った英検問題を生成します</p>
                <form onSubmit={(e) => {e.preventDefault(); generateProblem();}} className="bg-white p-4 sm:p-6 rounded-xl shadow-md mb-8 no-print">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6 mb-4">
                        <div><label htmlFor="level-select" className="block text-sm font-medium text-slate-700 mb-2">級を選択</label><select id="level-select" value={level} onChange={(e) => setLevel(e.target.value)} className="w-full p-3 bg-slate-100 border-transparent border-2 focus:border-sky-500 focus:ring-sky-500 rounded-lg transition text-sm sm:text-base">{levels.map((l) => (<option key={l.id} value={l.id}>{l.name}</option>))}</select></div>
                        <div><label htmlFor="type-select" className="block text-sm font-medium text-slate-700 mb-2">問題形式を選択</label><select id="type-select" value={questionType} onChange={(e) => setQuestionType(e.target.value)} className="w-full p-3 bg-slate-100 border-transparent border-2 focus:border-sky-500 focus:ring-sky-500 rounded-lg transition text-sm sm:text-base">{questionTypes[level].map((qt) => (<option key={qt.id} value={qt.id}>{qt.name}</option>))}</select></div>
                    </div>
                    <div className="mb-6">
                        <label className="block text-sm font-medium text-slate-700 mb-2">出題モード</label>
                        <div className="flex items-center space-x-2 sm:space-x-4 bg-slate-100 rounded-lg p-1">
                            <button type="button" onClick={() => setQuestionSource('ai')} className={`w-full text-center px-2 sm:px-4 py-2 rounded-md transition text-xs sm:text-base ${questionSource === 'ai' ? 'bg-sky-600 text-white shadow' : 'text-slate-600 hover:bg-slate-200'}`}>AIオリジナル</button>
                            <button type="button" onClick={() => setQuestionSource('past_exam')} className={`w-full text-center px-2 sm:px-4 py-2 rounded-md transition text-xs sm:text-base ${questionSource === 'past_exam' ? 'bg-sky-600 text-white shadow' : 'text-slate-600 hover:bg-slate-200'}`}>過去問ベース</button>
                        </div>
                    </div>
                    <button type="submit" disabled={isLoading || isAudioLoading || isImageLoading} className="w-full bg-sky-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition-transform transform hover:scale-105 disabled:bg-slate-400 disabled:cursor-not-allowed disabled:scale-100 flex items-center justify-center text-sm sm:text-base">
                        {isLoading || isAudioLoading || isImageLoading ? '生成中...' : '新しい問題を生成'}
                    </button>
                </form>
                {error && (<div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6" role="alert"><strong className="font-bold">エラー: </strong><span className="block sm:inline">{error}</span></div>)}
                {problem && !isLoading && isTimerActive && questionType !== 'speaking' && (
                  <div className="bg-white p-4 rounded-xl shadow-md mb-6 text-center no-print">
                    <p className="text-slate-600 text-sm">残り時間</p>
                    <p className={`text-4xl font-bold tracking-wider ${timeLeft <= 10 ? 'text-red-500 animate-pulse' : 'text-slate-800'}`}>{Math.floor(timeLeft / 60)}:{('0' + (timeLeft % 60)).slice(-2)}</p>
                  </div>
                )}
                {renderProblem()}
            </div>
          );
        }

        // --- History & Analysis Component ---
        function HistoryView({ user }) {
            const [history, setHistory] = React.useState([]);
            const [loading, setLoading] = React.useState(true);

            React.useEffect(() => {
                if (!user) return;
                const q = query(collection(db, `artifacts/${appId}/users/${user.uid}/history`));
                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    const historyData = [];
                    querySnapshot.forEach((doc) => {
                        historyData.push({ id: doc.id, ...doc.data() });
                    });
                    historyData.sort((a, b) => b.timestamp?.seconds - a.timestamp?.seconds);
                    setHistory(historyData);
                    setLoading(false);
                }, (error) => {
                    console.error("Error fetching history: ", error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [user]);

            const totalQuestions = history.length;
            const correctAnswers = history.filter(item => item.isCorrect).length;
            const correctPercentage = totalQuestions > 0 ? ((correctAnswers / totalQuestions) * 100).toFixed(1) : 0;

            if (loading) {
                return <div className="text-center p-10">読込中...</div>;
            }

            return (
                <div className="animate-fade-in">
                    <div className="bg-white p-6 rounded-xl shadow-md mb-8">
                        <h2 className="text-lg sm:text-2xl font-bold text-slate-800 mb-4">学習データ分析</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-center">
                            <div className="bg-slate-100 p-4 rounded-lg">
                                <p className="text-xs sm:text-sm text-slate-500">総解答数</p>
                                <p className="text-2xl sm:text-3xl font-bold text-sky-600">{totalQuestions}</p>
                            </div>
                            <div className="bg-slate-100 p-4 rounded-lg">
                                <p className="text-xs sm:text-sm text-slate-500">正答率</p>
                                <p className="text-2xl sm:text-3xl font-bold text-green-600">{correctPercentage}%</p>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white p-6 rounded-xl shadow-md">
                        <h2 className="text-lg sm:text-2xl font-bold text-slate-800 mb-4">解答履歴</h2>
                        <div className="space-y-4 max-h-96 overflow-y-auto pr-2">
                            {history.length > 0 ? history.map(item => (
                                <div key={item.id} className={`p-3 sm:p-4 rounded-lg border-l-4 ${item.isCorrect ? 'border-green-500 bg-green-50' : 'border-red-500 bg-red-50'}`}>
                                    <p className="font-semibold text-sm sm:text-base text-slate-700 truncate">{item.question}</p>
                                    <div className="text-xs text-slate-500 mt-1 flex justify-between">
                                        <span>{item.level} / {item.questionType}</span>
                                        <span>{item.timestamp ? new Date(item.timestamp.seconds * 1000).toLocaleString('ja-JP') : ''}</span>
                                    </div>
                                </div>
                            )) : (
                                <p className="text-center text-sm sm:text-base text-slate-500 py-8">解答履歴はまだありません。</p>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
